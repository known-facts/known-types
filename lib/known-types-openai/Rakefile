require 'pathname'
require 'yaml'

HEADER = "This is free and unencumbered software released into the public domain."

namespace :codegen do
  task groups: %w(openapi.yaml) do |t|
    spec = OpenAI::Spec.parse(t.prerequisites.first)
    module_names = spec.group_ids.map { |g| g.gsub('-', '_') }.sort
    module_names.each do |module_name|
      module_path = Pathname("src/groups/#{module_name}.rs")
      File.open(module_path, 'w') do |out|
        out.puts "// #{HEADER}"
      end
    end
    File.open('src/groups.rs', 'w') do |out|
      out.puts "// #{HEADER}"
      out.puts
      module_names.each do |module_name|
        out.puts "pub mod #{module_name};"
      end
    end
  end
end

module OpenAI
  class Spec
    def self.parse(path)
      self.new(YAML.load_file(path, aliases: true))
    end

    def initialize(spec) @spec = spec end
    def group_ids() self.groups.map { |g| g['id'] } end
    def groups() @spec['x-oaiMeta']['groups'] end
  end # Spec
end # OpenAI
